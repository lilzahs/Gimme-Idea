// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// ENUMS & TYPES (Mapped from SQL Checks)
// =============================================
enum ProjectType {
  project
  idea
}

enum ProjectCategory {
  DeFi
  NFT
  Gaming
  Infrastructure
  DAO
  DePIN
  Social
  Mobile
  Security
  Payment
  Developer_Tooling @map("Developer Tooling")
  ReFi
  Content
  Dapp
  Blinks
}

enum ProjectStage {
  Idea
  Prototype
  Devnet
  Mainnet
}

enum TransactionType {
  tip
  bounty
  reward
}

enum TransactionStatus {
  pending
  confirmed
  failed
}

enum HackathonStatus {
  upcoming
  open
  ongoing
  judging
  completed
}

enum TimelineStatus {
  pending
  active
  done
}

enum ParticipantRole {
  member
  captain
  mentor
  judge
}

// =============================================
// MODELS
// =============================================

model users {
  id               String    @id @default(uuid()) @db.Uuid
  wallet           String    @unique @db.VarChar(255)
  username         String    @unique @db.VarChar(100)
  bio              String?
  avatar           String?
  reputation_score Int       @default(0)
  balance          Decimal   @default(0) @db.Decimal(18, 9)
  social_links     Json?     @default("{}")
  last_login_at    DateTime? @db.Timestamptz(6)
  login_count      Int       @default(0)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  projects               projects[]
  comments               comments[]
  transactions           transactions[]
  project_votes          project_votes[]
  comment_likes          comment_likes[]
  hackathon_participants hackathon_participants[]
  hackathon_teams_led    hackathon_teams[]        @relation("TeamCaptain")
  user_hackathon_tasks   user_hackathon_tasks[]
}

model projects {
  id             String          @id @default(uuid()) @db.Uuid
  type           ProjectType     @default(project)
  author_id      String          @db.Uuid
  title          String          @db.VarChar(255)
  description    String
  category       ProjectCategory
  stage          ProjectStage
  tags           String[]
  website        String?
  bounty         Decimal?        @default(0) @db.Decimal(18, 9)
  votes          Int             @default(0)
  feedback_count Int             @default(0)
  image_url      String?

  // Idea specific fields
  problem        String?
  solution       String?
  opportunity    String?
  go_market      String?
  team_info      String?
  is_anonymous   Boolean?        @default(false)

  created_at     DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?       @default(now()) @db.Timestamptz(6)

  // Relations
  author         users           @relation(fields: [author_id], references: [id], onDelete: Cascade)
  comments       comments[]
  transactions   transactions[]
  project_votes  project_votes[]

  @@index([type])
  @@index([author_id])
  @@index([category])
  @@index([stage])
  @@index([votes(sort: Desc)])
  @@index([created_at(sort: Desc)])
}

model comments {
  id                String    @id @default(uuid()) @db.Uuid
  project_id        String    @db.Uuid
  user_id           String    @db.Uuid
  content           String
  parent_comment_id String?   @db.Uuid
  is_anonymous      Boolean?  @default(false)
  likes             Int       @default(0)
  tips_amount       Decimal?  @default(0) @db.Decimal(18, 9)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  project        projects        @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user           users           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  parent         comments?       @relation("CommentReplies", fields: [parent_comment_id], references: [id], onDelete: Cascade)
  replies        comments[]      @relation("CommentReplies")
  transactions   transactions[]
  comment_likes  comment_likes[]

  @@index([project_id])
  @@index([user_id])
  @@index([parent_comment_id])
  @@index([created_at(sort: Desc)])
}

model transactions {
  id         String            @id @default(uuid()) @db.Uuid
  tx_hash    String            @unique @db.VarChar(255)
  from_wallet String           @db.VarChar(255)
  to_wallet   String           @db.VarChar(255)
  amount     Decimal           @db.Decimal(18, 9)
  type       TransactionType
  project_id String?           @db.Uuid
  comment_id String?           @db.Uuid
  user_id    String            @db.Uuid
  status     TransactionStatus @default(pending)
  created_at DateTime?         @default(now()) @db.Timestamptz(6)

  // Relations
  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  project    projects? @relation(fields: [project_id], references: [id])
  comment    comments? @relation(fields: [comment_id], references: [id])

  @@index([tx_hash])
  @@index([user_id])
  @@index([project_id])
  @@index([created_at(sort: Desc)])
}

model project_votes {
  id         String    @id @default(uuid()) @db.Uuid
  project_id String    @db.Uuid
  user_id    String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  project    projects  @relation(fields: [project_id], references: [id], onDelete: Cascade)
  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([project_id, user_id])
  @@index([project_id])
  @@index([user_id])
}

model comment_likes {
  id         String    @id @default(uuid()) @db.Uuid
  comment_id String    @db.Uuid
  user_id    String    @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  // Relations
  comment    comments  @relation(fields: [comment_id], references: [id], onDelete: Cascade)
  user       users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([comment_id, user_id])
  @@index([comment_id])
  @@index([user_id])
}

// =============================================
// HACKATHON MODELS
// =============================================

model hackathons {
  id                    String            @id @default(uuid()) @db.Uuid
  title                 String            @db.VarChar(255)
  slug                  String            @unique @db.VarChar(255)
  description           String?
  banner_url            String?
  start_date            DateTime          @db.Timestamptz(6)
  end_date              DateTime          @db.Timestamptz(6)
  registration_deadline DateTime?         @db.Timestamptz(6)
  status                HackathonStatus?  @default(upcoming)
  prize_pool            String?           @db.VarChar(100)
  rules                 String?
  created_at            DateTime?         @default(now()) @db.Timestamptz(6)
  updated_at            DateTime?         @default(now()) @db.Timestamptz(6)

  // Relations
  timeline              hackathon_timeline[]
  teams                 hackathon_teams[]
  participants          hackathon_participants[]
  tasks                 hackathon_tasks[]

  @@index([status])
  @@index([slug])
}

model hackathon_timeline {
  id            String         @id @default(uuid()) @db.Uuid
  hackathon_id  String         @db.Uuid
  title         String         @db.VarChar(100)
  date          DateTime       @db.Timestamptz(6)
  description   String?
  status        TimelineStatus? @default(pending)
  display_order Int            @default(0)
  created_at    DateTime?      @default(now()) @db.Timestamptz(6)

  // Relations
  hackathon     hackathons     @relation(fields: [hackathon_id], references: [id], onDelete: Cascade)

  @@index([hackathon_id])
  @@index([display_order])
}

model hackathon_teams {
  id           String                   @id @default(uuid()) @db.Uuid
  hackathon_id String                   @db.Uuid
  name         String                   @db.VarChar(100)
  avatar_url   String?
  project_link String?
  captain_id   String?                  @db.Uuid
  score        Decimal?                 @default(0) @db.Decimal(10, 2)
  rank         Int?
  is_verified  Boolean?                 @default(false)
  created_at   DateTime?                @default(now()) @db.Timestamptz(6)
  updated_at   DateTime?                @default(now()) @db.Timestamptz(6)

  // Relations
  hackathon    hackathons               @relation(fields: [hackathon_id], references: [id], onDelete: Cascade)
  captain      users?                   @relation("TeamCaptain", fields: [captain_id], references: [id])
  members      hackathon_participants[]

  @@unique([hackathon_id, name])
  @@index([hackathon_id])
  @@index([score(sort: Desc)])
}

model hackathon_participants {
  id           String          @id @default(uuid()) @db.Uuid
  hackathon_id String          @db.Uuid
  user_id      String          @db.Uuid
  team_id      String?         @db.Uuid
  role         ParticipantRole? @default(member)
  joined_at    DateTime?       @default(now()) @db.Timestamptz(6)

  // Relations
  hackathon    hackathons      @relation(fields: [hackathon_id], references: [id], onDelete: Cascade)
  user         users           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  team         hackathon_teams? @relation(fields: [team_id], references: [id])

  @@unique([hackathon_id, user_id])
  @@index([hackathon_id])
  @@index([user_id])
  @@index([team_id])
}

model hackathon_tasks {
  id            String                 @id @default(uuid()) @db.Uuid
  hackathon_id  String                 @db.Uuid
  content       String                 @db.VarChar(255)
  is_required   Boolean?               @default(true)
  display_order Int?                   @default(0)
  created_at    DateTime?              @default(now()) @db.Timestamptz(6)

  // Relations
  hackathon     hackathons             @relation(fields: [hackathon_id], references: [id], onDelete: Cascade)
  completed_by  user_hackathon_tasks[]
}

model user_hackathon_tasks {
  id           String          @id @default(uuid()) @db.Uuid
  task_id      String          @db.Uuid
  user_id      String          @db.Uuid
  completed_at DateTime?       @default(now()) @db.Timestamptz(6)

  // Relations
  task         hackathon_tasks @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user         users           @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([task_id, user_id])
}